@using LoanTracker.Web.Store.ProjectState
@using System.Globalization
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<ProjectState> ProjectState

@if (ProjectState.Value.IsLoading)
{
    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
}
else if (!ProjectState.Value.InterestAccruals.Any())
{
    <MudAlert Severity="Severity.Info">
        No interest accruals calculated yet. Interest accruals begin after loan approval and disbursements.
    </MudAlert>
}
else
{
    var totalInterest = ProjectState.Value.InterestAccruals.Sum(a => a.InterestAmount);
    var totalPrincipal = ProjectState.Value.InterestAccruals.LastOrDefault()?.PrincipalBalance ?? 0;

    <div class="mb-4">
        <MudGrid>
            <MudItem xs="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.caption" Color="Color.Default">Total Accruals</MudText>
                    <MudText Typo="Typo.h6">@ProjectState.Value.InterestAccruals.Count()</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.caption" Color="Color.Default">Current Principal</MudText>
                    <MudText Typo="Typo.h6">@totalPrincipal.ToString("C", CultureInfo.GetCultureInfo("en-US"))</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.caption" Color="Color.Default">Total Interest Accrued</MudText>
                    <MudText Typo="Typo.h6" Color="Color.Primary">@totalInterest.ToString("C", CultureInfo.GetCultureInfo("en-US"))</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.caption" Color="Color.Default">Average Monthly Interest</MudText>
                    <MudText Typo="Typo.h6">@((totalInterest / Math.Max(1, ProjectState.Value.InterestAccruals.Count())).ToString("C", CultureInfo.GetCultureInfo("en-US")))</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </div>

    <MudTable Items="@ProjectState.Value.InterestAccruals.OrderByDescending(a => a.DueDate)" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>Period</MudTh>
            <MudTh>Accrual Date</MudTh>
            <MudTh>Due Date</MudTh>
            <MudTh>Principal Balance</MudTh>
            <MudTh>Interest Rate</MudTh>
            <MudTh>Interest Amount</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Period">
                <MudText Typo="Typo.body2"><strong>@context.Period</strong></MudText>
            </MudTd>
            <MudTd DataLabel="Accrual Date">
                @context.AccrualDate.ToString("MMM dd, yyyy")
            </MudTd>
            <MudTd DataLabel="Due Date">
                @context.DueDate.ToString("MMM dd, yyyy")
            </MudTd>
            <MudTd DataLabel="Principal Balance">
                @context.PrincipalBalance.ToString("C", CultureInfo.GetCultureInfo("en-US"))
            </MudTd>
            <MudTd DataLabel="Interest Rate">
                @context.InterestRate.ToString("F2")%
            </MudTd>
            <MudTd DataLabel="Interest Amount">
                <MudText Typo="Typo.body2" Color="Color.Primary">
                    <strong>@context.InterestAmount.ToString("C", CultureInfo.GetCultureInfo("en-US"))</strong>
                </MudText>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    [Parameter]
    public Guid LoanId { get; set; }
}
